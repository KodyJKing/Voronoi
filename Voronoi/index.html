<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
    </head>
    <body>
        <canvas id="myCanvas" width=800 height=800></canvas>
        <script src="voronoi.js"></script>
        <script>
            {
                let canvas = document.getElementById("myCanvas")
                let ctx = canvas.getContext("2d")
                let points = []
                let colors = []
                let mouse = {x: 0, y: 0}
                canvas.onmousedown = function(e) {
                    let newPoint = new Vector(e.x, e.y)
                    points.push(newPoint)
                    colors.push(`hsl(${(Math.random() * 360) | 0}, 50%, 50%)`)
                    // render()
                }
                canvas.onmousemove = function(e) {
                    mouse.x = e.x
                    mouse.y = e.y
                }
                function render() {
                    ctx.fillStyle = "hsl(236, 100%, 90%)"
                    ctx.fillRect(0, 0, canvas.width, canvas.height)

                    for (let point of points) {
                        let angle = Math.random() * 2 * Math.PI
                        let dx = Math.cos(angle)
                        let dy = Math.sin(angle)
                        point.x += dx
                        point.y += dy
                    }

                    let diagram = new VoronoiDiagram(points, [
                        new Vector(100, 100),
                        new Vector(700, 100),
                        new Vector(700, 700),
                        new Vector(100, 700)
                    ])

                    let newPoints = []
                    let colorIndex = 0
                    for (let polygon of diagram.polygons) {
                        let points = polygon.sortedPoints()
                        if (points.length >= 3) {
                            ctx.fillStyle = colors[colorIndex]
                            polygonPath(points)
                            ctx.fill()
                            polygonPath(points)
                            ctx.stroke()
                        }
                        drawCircle("black", polygon.point)
                        colorIndex++
                        let average = points.reduce((a, b) => a.add(b), new Vector(0, 0)).multiply(1 / points.length)
                        if (!Number.isFinite(average.x) || !Number.isFinite(average.y))
                            newPoints.push(polygon.point)
                        else
                            newPoints.push(polygon.point.lerp(average, 0.1))
                    }

                    points = newPoints

                    setTimeout(() => render(), 1)
                }
                function drawLine(a, b) {
                    ctx.beginPath()
                    ctx.moveTo(a.x, a.y)
                    ctx.lineTo(b.x, b.y)
                    ctx.stroke()
                }
                function drawCircle(color, a) {
                    ctx.fillStyle = color
                    ctx.beginPath()
                    ctx.arc(a.x, a.y, 5, 0, 2 * Math.PI)
                    ctx.fill()
                }
                function polygonPath(polygon) {
                    ctx.beginPath()
                    ctx.moveTo(polygon[0].x, polygon[0].y)
                    for (let i = 1; i < polygon.length; i++)
                        ctx.lineTo(polygon[i].x, polygon[i].y)
                    ctx.closePath()
                }
                render()
            }
        </script>
    </body>
</html>